<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Verificación de Pozos de Inundación</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        body {
            background-color: #f8f9fa;
            padding-bottom: 10px;
        }
        .main-container {
            max-width: 1000px;
            margin: 20px auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            overflow: hidden; /* For rounded corners with tabs */
        }
        .tab-content {
            padding: 25px;
            border: 1px solid #dee2e6;
            border-top: none;
            background: white;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
        }
        h1 {
            font-size: 1.5rem;
            text-align: center;
            margin-bottom: 20px;
            color: #343a40;
        }
        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 5px;
        }
        .table-responsive {
            margin-top: 20px;
        }
        th {
            vertical-align: middle;
            text-align: center;
        }
        .zh-text {
            font-size: 0.9em;
            color: #555;
            display: block;
            margin-bottom: 2px;
        }
        .es-text {
            font-weight: bold;
            display: block;
        }
    </style>
</head>
<body>

<!-- Login Overlay -->
<div id="loginOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #343a40; z-index: 10000; display: flex; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 10px; width: 300px; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.5);">
        <h3 style="margin-bottom: 20px; color: #343a40;">Iniciar Sesión</h3>
        <input type="text" id="loginUser" class="form-control mb-3" placeholder="Usuario">
        <input type="password" id="loginPass" class="form-control mb-3" placeholder="Contraseña">
        <button onclick="performLogin()" class="btn btn-primary w-100">Entrar</button>
        <div id="loginError" style="color: red; margin-top: 10px; font-size: 0.9em; display: none;">Credenciales incorrectas</div>
    </div>
</div>

<div class="container main-container" id="mainApp" style="display: none;">
    
    <!-- Nav Tabs -->
    <ul class="nav nav-tabs" id="appTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="verificacion-tab" data-bs-toggle="tab" data-bs-target="#verificacion" type="button" role="tab" aria-controls="verificacion" aria-selected="true">Verificación</button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="appTabsContent">
        <!-- Tab: Verificación -->
        <div class="tab-pane fade show active" id="verificacion" role="tabpanel" aria-labelledby="verificacion-tab">
            
            <h1>
                <span class="zh-text">排洪井安全、环境、排水生产检查表</span>
                <span class="es-text">Lista de verificación ambiental y de seguridad de pozos de inundación</span>
            </h1>

            <form id="inspectionForm">
                <!-- Metadata Section -->
                <div class="row form-section">
                    <div class="col-md-4 mb-1">
                        <label for="date" class="form-label">日期 Fecha:</label>
                        <input type="date" class="form-control" id="date" required>
                    </div>
                    <div class="col-md-4 mb-1">
                        <label for="dayShiftPerson" class="form-label">白班当班人 Dia (Nombre):</label>
                        <input type="text" class="form-control" id="dayShiftPerson">
                    </div>
                    <div class="col-md-4 mb-1">
                        <label for="nightShiftPerson" class="form-label">夜班当班人 Noche (Nombre):</label>
                        <input type="text" class="form-control" id="nightShiftPerson">
                    </div>
                </div>

                <!-- Checklist Table -->
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 50%">检查项目 Artículos Marcados</th>
                                <th style="width: 25%">白班 Dia</th>
                                <th style="width: 25%">夜班 Noche</th>
                            </tr>
                        </thead>
                        <tbody id="checklistBody">
                            <!-- Items will be injected here by JS -->
                        </tbody>
                    </table>
                </div>

                <!-- Remarks Section -->
                <div class="row mt-2">
                    <div class="col-md-6 mb-1">
                        <label for="dayRemarks" class="form-label">白班备注 Observación (Dia):</label>
                        <textarea class="form-control" id="dayRemarks" rows="3"></textarea>
                    </div>
                    <div class="col-md-6 mb-1">
                        <label for="nightRemarks" class="form-label">夜班备注 Observación (Noche):</label>
                        <textarea class="form-control" id="nightRemarks" rows="3"></textarea>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-2">
                    <button type="button" class="btn btn-secondary me-md-2" onclick="clearForm()">Limpiar / Clear</button>
                    <button type="button" class="btn btn-success me-md-2" onclick="saveToDatabase()">Guardar en BD (Supabase)</button>
                    <button type="button" class="btn btn-danger" onclick="exportToPDF()">Generar PDF / Generate PDF</button>
                </div>
            </form>

        </div>
    </div>

</div>

<!-- Bootstrap JS Bundle (Required for Tabs) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- html2pdf.js for PDF Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<!-- Supabase JS Client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // --- SUPABASE CONFIGURATION ---
    const SUPABASE_URL = 'https://krkoacewzhigjjybgzng.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtya29hY2V3emhpZ2pqeWJnem5nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NTMwMDgsImV4cCI6MjA4MzAyOTAwOH0.XeNiavBsXx3Q6HOVw_btjqmXoYB1ux22lo5muy330Yw';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- LOGIN LOGIC ---
    async function performLogin() {
        const user = document.getElementById('loginUser').value;
        const pass = document.getElementById('loginPass').value;
        const errorMsg = document.getElementById('loginError');
        const btn = document.querySelector('#loginOverlay button');

        errorMsg.style.display = 'none';
        btn.disabled = true;
        btn.innerText = 'Verificando...';

        try {
            // Check credentials in 'users' table
            const { data, error } = await supabaseClient
                .from('users')
                .select('*')
                .eq('username', user)
                .maybeSingle();

            if (error) throw error;

            // Simple plain text password check (as requested/setup)
            if (data && data.password === pass) {
                // Success
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                // Trigger initial load
                loadDataByDate();
            } else {
                // Fail
                errorMsg.innerText = "Usuario o contraseña incorrectos";
                errorMsg.style.display = 'block';
            }
        } catch (err) {
            console.error(err);
            errorMsg.innerText = "Error de conexión";
            errorMsg.style.display = 'block';
        } finally {
            btn.disabled = false;
            btn.innerText = 'Entrar';
        }
    }

    // Allow Enter key to login
    document.getElementById('loginPass').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            performLogin();
        }
    });

    // Checklist Items Data
    const checklistItems = [
        {
            zh: "柴油发电机，油罐，油管是否是否有柴油溢出，柴油机内部是否漏油，油罐阀门是否关闭",
            es: "Si el motor diesel, el tanque de aceite y la tubería de aceite tienen fugas de aceite, Si la válvula del tanque diesel está cerrada",
            id: "q1"
        },
        {
            zh: "柴油漏油槽，发电机周围是否有油渍，油渍是否清理",
            es: "Tanque de fugas de aceite diesel, si hay manchas de aceite alrededor del generador y si las manchas de aceite se limpian",
            id: "q2"
        },
        {
            zh: "浮船是否牢靠，是否有浮块散架",
            es: "Si el pontón es confiable y si hay bloques flotantes que se desmoronan",
            id: "q3"
        },
        {
            zh: "2台水泵是否运行正常",
            es: "Funcionan normalmente las 2 bombas",
            id: "q4"
        },
        {
            zh: "道路及边坡是否正常，是否有滑坡现象",
            es: "Si los caminos y pendientes son normales y si hay algún fenómeno de derrumbe",
            id: "q5"
        },
        {
            zh: "垃圾是否进袋，每班次是否带走当班垃圾",
            es: "Si la basura se pone en la bolsa y si la basura de turno se retira en cada turno.",
            id: "q6"
        },
        {
            zh: "排洪井安全设施是否正常（安全网，安全钢绳）",
            es: "Si las instalaciones de seguridad de los pozos de descarga de inundación son normales (red segura, cuerda de acero de seguridad)",
            id: "q7"
        }
    ];

    // Render Checklist
    const tbody = document.getElementById('checklistBody');
    checklistItems.forEach((item, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <span class="zh-text">${index + 1}. ${item.zh}</span>
                <span class="es-text">${item.es}</span>
            </td>
            <td>
                <select class="form-select form-select-sm" name="day_${item.id}">
                    <option value="">-</option>
                    <option value="OK">SI</option>
                    <option value="X">NO</option>
                </select>
                <input type="text" class="form-control form-control-sm mt-1" placeholder="Nota..." name="day_note_${item.id}">
            </td>
            <td>
                <select class="form-select form-select-sm" name="night_${item.id}">
                    <option value="">-</option>
                    <option value="OK">SI</option>
                    <option value="X">NO</option>
                </select>
                <input type="text" class="form-control form-control-sm mt-1" placeholder="Nota..." name="night_note_${item.id}">
            </td>
        `;
        tbody.appendChild(row);
    });

    // Set today's date
    const dateInput = document.getElementById('date');
    dateInput.valueAsDate = new Date();

    // Listen for date changes
    dateInput.addEventListener('change', loadDataByDate);

    // Initial load
    loadDataByDate();

    // --- NEW: Load from Supabase ---
    async function loadDataByDate() {
        const date = dateInput.value;
        if (!date) return;

        try {
            const { data, error } = await supabaseClient
                .from('inspections')
                .select('*')
                .eq('inspection_date', date)
                .maybeSingle();

            if (error) {
                console.error('Error loading data:', error);
                return;
            }

            if (data) {
                document.getElementById('dayShiftPerson').value = data.day_shift_person || '';
                document.getElementById('nightShiftPerson').value = data.night_shift_person || '';
                document.getElementById('dayRemarks').value = data.day_remarks || '';
                document.getElementById('nightRemarks').value = data.night_remarks || '';

                const checklist = data.checklist_data || [];
                
                checklist.forEach(item => {
                    const daySelect = document.querySelector(`[name="day_${item.id}"]`);
                    const dayNote = document.querySelector(`[name="day_note_${item.id}"]`);
                    const nightSelect = document.querySelector(`[name="night_${item.id}"]`);
                    const nightNote = document.querySelector(`[name="night_note_${item.id}"]`);

                    if (daySelect) daySelect.value = item.day_status || '';
                    if (dayNote) dayNote.value = item.day_note || '';
                    if (nightSelect) nightSelect.value = item.night_status || '';
                    if (nightNote) nightNote.value = item.night_note || '';
                });
                console.log("Datos cargados para la fecha " + date);
            } else {
                console.log("No se encontraron datos para " + date + ", limpiando formulario.");
                document.getElementById('dayShiftPerson').value = '';
                document.getElementById('nightShiftPerson').value = '';
                document.getElementById('dayRemarks').value = '';
                document.getElementById('nightRemarks').value = '';
                
                document.querySelectorAll('tbody select').forEach(el => el.value = '');
                document.querySelectorAll('tbody input').forEach(el => el.value = '');
            }
        } catch (error) {
            console.error('Error in loadDataByDate:', error);
        }
    }

    // Clear Form
    function clearForm() {
        if(confirm('¿Borrar todo el formulario?')) {
            document.getElementById('inspectionForm').reset();
            document.getElementById('date').valueAsDate = new Date();
        }
    }

    // Handle Submit
    document.getElementById('inspectionForm').addEventListener('submit', function(e) {
        e.preventDefault();
    });

    // --- NEW: Save to Supabase ---
    async function saveToDatabase(silent = false) {
        const btn = document.querySelector('button[onclick="saveToDatabase()"]');
        const originalText = btn ? btn.innerText : '';
        if(btn) {
             btn.innerText = "Guardando...";
             btn.disabled = true;
        }

        try {
            // Collect Data
            const checklistData = checklistItems.map(item => {
                return {
                    id: item.id,
                    question_zh: item.zh,
                    question_es: item.es,
                    day_status: document.querySelector(`[name="day_${item.id}"]`).value,
                    day_note: document.querySelector(`[name="day_note_${item.id}"]`).value,
                    night_status: document.querySelector(`[name="night_${item.id}"]`).value,
                    night_note: document.querySelector(`[name="night_note_${item.id}"]`).value
                };
            });

            const inspectionDate = document.getElementById('date').value;

            const payload = {
                inspection_date: inspectionDate,
                day_shift_person: document.getElementById('dayShiftPerson').value,
                night_shift_person: document.getElementById('nightShiftPerson').value,
                day_remarks: document.getElementById('dayRemarks').value,
                night_remarks: document.getElementById('nightRemarks').value,
                checklist_data: checklistData
            };

            // Check if record exists
            const { data: existing } = await supabaseClient
                .from('inspections')
                .select('id')
                .eq('inspection_date', inspectionDate)
                .maybeSingle();
            
            let result;
            if (existing) {
                // Update
                result = await supabaseClient
                    .from('inspections')
                    .update(payload)
                    .eq('id', existing.id);
            } else {
                // Insert
                result = await supabaseClient
                    .from('inspections')
                    .insert([payload]);
            }

            if (result.error) {
                throw result.error;
            }

            if(!silent) alert('¡Datos guardados exitosamente en Supabase!');
            return true;

        } catch (error) {
            console.error('Error:', error);
            alert('Error al guardar: ' + error.message);
            return false;
        } finally {
            if(btn) {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
    }

    async function exportToPDF() {
        // 1. Auto-save first
        const saved = await saveToDatabase(true); 
        
        if (!saved) {
             if(!confirm("No se pudo guardar en la base de datos. ¿Generar PDF de todos modos?")) return;
        }

        // 2. Gather Data for PDF
        const date = document.getElementById('date').value;
        const dayPerson = document.getElementById('dayShiftPerson').value || '-';
        const nightPerson = document.getElementById('nightShiftPerson').value || '-';
        const dayRemarks = document.getElementById('dayRemarks').value || '-';
        const nightRemarks = document.getElementById('nightRemarks').value || '-';

        // 3. Build Table Rows HTML
        let tableRows = '';
        checklistItems.forEach(item => {
            const daySelect = document.querySelector(`[name="day_${item.id}"]`);
            const dayNoteInput = document.querySelector(`[name="day_note_${item.id}"]`);
            const nightSelect = document.querySelector(`[name="night_${item.id}"]`);
            const nightNoteInput = document.querySelector(`[name="night_note_${item.id}"]`);

            const formatStatus = (val) => {
                if (val === 'OK') return '√ (Normal)';
                if (val === 'X') return 'X (Anormal)';
                if (val === 'NA') return 'N/A';
                return '-';
            };

            const dayStatus = formatStatus(daySelect.value);
            const dayNote = dayNoteInput.value;
            const nightStatus = formatStatus(nightSelect.value);
            const nightNote = nightNoteInput.value;

            tableRows += `
                <tr>
                    <td style="border: 1px solid black; padding: 5px;">
                        <div style="color: #333; font-size: 10px;">${item.zh}</div>
                        <div style="font-weight: bold; font-size: 11px;">${item.es}</div>
                    </td>
                    <td style="border: 1px solid black; padding: 5px; text-align: center; vertical-align: middle;">
                        <div style="font-weight: bold;">${dayStatus}</div>
                        ${dayNote ? `<div style="font-style: italic; font-size: 9px; margin-top: 2px;">${dayNote}</div>` : ''}
                    </td>
                    <td style="border: 1px solid black; padding: 5px; text-align: center; vertical-align: middle;">
                        <div style="font-weight: bold;">${nightStatus}</div>
                        ${nightNote ? `<div style="font-style: italic; font-size: 9px; margin-top: 2px;">${nightNote}</div>` : ''}
                    </td>
                </tr>
            `;
        });

        // 4. Construct Complete HTML
        const htmlContent = `
            <div style="font-family: Arial, sans-serif; color: black; padding: 45px; background: white; width: 100%; box-sizing: border-box;">
                
                <!-- Header -->
                <div style="text-align: center; margin-bottom: 25px;">
                    <h2 style="margin: 0 0 8px 0; font-size: 20px;">排洪井安全、环境、排水生产检查表</h2>
                    <h3 style="margin: 0; font-size: 18px;">Lista de verificación ambiental y de seguridad de pozos de inundación</h3>
                </div>

                <!-- Meta Info -->
                <div style="margin-bottom: 20px; border: 1px solid black; padding: 12px; background-color: #f8f9fa;">
                    <table style="width: 100%; font-size: 13px;">
                        <tr>
                            <td><strong>日期 Fecha:</strong> ${date}</td>
                            <td><strong>白班 Dia:</strong> ${dayPerson}</td>
                            <td><strong>夜班 Noche:</strong> ${nightPerson}</td>
                        </tr>
                    </table>
                </div>

                <!-- Checklist Table -->
                <table style="width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 25px;">
                    <thead>
                        <tr style="background-color: #e9ecef;">
                            <th style="border: 1px solid black; padding: 10px; width: 50%;">检查项目 Artículos Marcados</th>
                            <th style="border: 1px solid black; padding: 10px; width: 25%;">白班 Dia</th>
                            <th style="border: 1px solid black; padding: 10px; width: 25%;">夜班 Noche</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>

                <!-- Remarks -->
                <div style="font-size: 12px;">
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: bold; background-color: #e9ecef; padding: 6px; border: 1px solid black; border-bottom: none;">
                            白班备注 Observación:
                        </div>
                        <div style="border: 1px solid black; padding: 10px; min-height: 60px; white-space: pre-wrap;">${dayRemarks}</div>
                    </div>
                    <div>
                        <div style="font-weight: bold; background-color: #e9ecef; padding: 6px; border: 1px solid black; border-bottom: none;">
                            夜班备注 Observación:
                        </div>
                        <div style="border: 1px solid black; padding: 10px; min-height: 60px; white-space: pre-wrap;">${nightRemarks}</div>
                    </div>
                </div>

            </div>
        `;

        // 5. Create Temporary Container (Visible Overlay)
        const container = document.createElement('div');
        // Reset scroll position to ensure capture starts from top
        window.scrollTo(0, 0);
        
        container.style.position = 'fixed';
        container.style.top = '0';
        container.style.left = '0';
        container.style.width = '100vw'; 
        container.style.height = '100vh';
        container.style.zIndex = '9999'; // On top of everything
        container.style.backgroundColor = 'rgba(0,0,0,0.8)'; // Dim background
        container.style.overflowY = 'auto'; 
        container.style.display = 'flex';
        container.style.justifyContent = 'center';
        container.style.paddingTop = '10px';
        
        // Inner wrapper for the actual A4 page look
        const pageWrapper = document.createElement('div');
        pageWrapper.innerHTML = htmlContent;
        // Exact A4 width in px (at 96 DPI, 210mm is approx 794px). 
        // We use slightly less to ensure margins fit.
        pageWrapper.style.width = '210mm'; 
        // REMOVED minHeight to prevent forcing a full page that might overflow by 1px
        // pageWrapper.style.minHeight = '297mm'; 
        pageWrapper.style.background = 'white';
        pageWrapper.style.boxShadow = '0 0 10px rgba(0,0,0,0.5)';
        // Ensure content doesn't stretch height unnecessarily
        pageWrapper.style.height = 'fit-content'; 
        
        // Clear container and append wrapper
        container.innerHTML = ''; 
        container.appendChild(pageWrapper);
        
        // Add a "Generating..." message
        const message = document.createElement('div');
        message.textContent = "Generando PDF... / Generating PDF...";
        message.style.position = 'fixed';
        message.style.top = '10px';
        message.style.left = '50%';
        message.style.transform = 'translateX(-50%)';
        message.style.background = '#28a745';
        message.style.color = 'white';
        message.style.padding = '10px 20px';
        message.style.borderRadius = '5px';
        message.style.zIndex = '10000';
        container.appendChild(message);

        document.body.appendChild(container);

        // 6. Generate PDF with Delay
        setTimeout(() => {
            const opt = {
                margin:       0,
                filename:     `Inspeccion_${date}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { 
                    scale: 2, 
                    useCORS: true,
                    scrollY: 0, // CRITICAL: Ignore user scroll position
                    windowWidth: document.documentElement.offsetWidth // Ensure full width capture
                },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(pageWrapper).save().then(() => {
                document.body.removeChild(container);
            });
        }, 800); // Increased delay slightly
    }
</script>

</body>
</html>